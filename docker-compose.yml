# Klask Environment
# Full-stack code search engine with Rust backend and React frontend
#
# Quick Start:
#   docker compose up -d
#   Access frontend: http://localhost:8080
#   Access backend API: http://localhost:3000
services:
    # PostgreSQL Database
    postgres:
        image: postgres:18-alpine
        container_name: klask-postgres
        environment:
            POSTGRES_DB: klask_dev
            POSTGRES_USER: klask_user
            POSTGRES_PASSWORD: klask_password
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - klask-network
        restart: unless-stopped

    # Klask Backend (Rust)
    klask-backend:
        image: ghcr.io/klask-dev/klask-backend:latest
        container_name: klask-backend
        environment:
            - DATABASE_URL=postgres://klask_user:klask_password@postgres:5432/klask_dev
            - RUST_LOG=info
            - PORT=3000
            - HOST=0.0.0.0
            - ENCRYPTION_KEY=${ENCRYPTION_KEY:-default-encryption-key-change-me}
            - JWT_SECRET=${JWT_SECRET:-default-jwt-key-change-me}
        ports:
            - "3000:3000"
        volumes:
            - klask_data:/app/data
            - klask_index:/app/index
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - klask-network
        restart: unless-stopped

    # Klask Frontend (React)
    klask-frontend:
        image: ghcr.io/klask-dev/klask-frontend:latest
        container_name: klask-frontend
        ports:
            - "8080:8080"
        networks:
            - klask-network
        restart: unless-stopped

    # Welcome message service - displays URLs and status once everything is ready
    welcome:
        image: alpine:latest
        container_name: klask-welcome
        depends_on:
            klask-backend:
                condition: service_healthy
            klask-frontend:
                condition: service_healthy
        networks:
            - klask-network
        restart: "no"
        entrypoint: /bin/sh
        command:
            - -c
            - |
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘                    ğŸš€ Klask is Ready! ğŸš€                       â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "ğŸ“Š Frontend:  http://localhost:8080"
              echo "ğŸ”Œ Backend:   http://localhost:3000"
              echo "ğŸ—„ï¸  Database:  localhost:5432"
              echo ""
              echo "ğŸ“š Useful commands:"
              echo "  â€¢ View logs:   docker logs -f <container_name>"
              echo "  â€¢ Stop:        docker compose -f docker-compose.yml down"
              echo "  â€¢ With tools:  docker compose -f docker-compose.yml --profile tools up -d"
              echo ""
              echo "âœ… All services are healthy and running!"
              echo ""

volumes:
    postgres_data:
    klask_data:
    klask_index:

networks:
    klask-network:
        driver: bridge
