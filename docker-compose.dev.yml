# Klask Development Environment
# Full-stack code search engine with Rust backend and React frontend
#
# Quick Start:
#   docker compose -f docker-compose.dev.yml up -d
#   A welcome message will display URLs once all services are ready!
#   Access frontend: http://localhost:8081
#   Access backend API: http://localhost:3001
#   Access pgAdmin: http://localhost:5050 (with --profile tools)
#
# Startup Order:
#   1. PostgreSQL starts first
#   2. Backend waits for database to be healthy
#   3. Frontend waits for backend to be healthy
#   4. Welcome service displays URLs when everything is ready
#
# With optional tools (pgAdmin, Redis):
#   docker compose -f docker-compose.dev.yml --profile tools up -d

services:
    # PostgreSQL Database
    postgres:
        image: postgres:18-alpine
        container_name: klask-postgres-dev
        environment:
            POSTGRES_DB: klask_dev
            POSTGRES_USER: klask_user
            POSTGRES_PASSWORD: klask_password
        ports:
            - "5433:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        networks:
            - klask-network
        restart: unless-stopped

    # Klask Backend (Rust)
    klask-backend:
        build:
            context: klask-rs
            dockerfile: Dockerfile
        container_name: klask-backend
        environment:
            - DATABASE_URL=postgres://klask_user:klask_password@postgres:5432/klask_dev
            - RUST_LOG=info
            - PORT=3000
            - HOST=0.0.0.0
            - ENCRYPTION_KEY=${ENCRYPTION_KEY:-default-encryption-key-change-me}
            - JWT_SECRET=${JWT_SECRET:-default-jwt-key-change-me}
        ports:
            - "3001:3000"
        volumes:
            - klask_data:/app/data
            - klask_index:/app/index
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - klask-network
        restart: unless-stopped


    # Klask Frontend (React)
    klask-frontend:
        build:
            context: klask-react
            dockerfile: Dockerfile
        container_name: klask-frontend
        ports:
            - "8081:8080"
        networks:
            - klask-network
        restart: unless-stopped
        environment:
            # Backend is exposed on localhost:3000, frontend calls it directly
            # No nginx proxy needed since backend has permissive CORS
            BACKEND_BASE_URL: "http://localhost:3001"

    # Welcome message service - displays URLs and status once everything is ready
    welcome:
        image: alpine:latest
        container_name: klask-welcome
        depends_on:
            klask-backend:
                condition: service_healthy
            klask-frontend:
                condition: service_healthy
        networks:
            - klask-network
        restart: "no"
        entrypoint: /bin/sh
        command:
            - -c
            - |
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘                    ğŸš€ Klask is Ready! ğŸš€                       â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "ğŸ“Š Frontend:  http://localhost:8081"
              echo "ğŸ”Œ Backend:   http://localhost:3001"
              echo "ğŸ—„ï¸  Database:  localhost:5432"
              echo ""
              echo "ğŸ“š Useful commands:"
              echo "  â€¢ View logs:   docker logs -f <container_name>"
              echo "  â€¢ Stop:        docker compose -f docker-compose.dev.yml down"
              echo "  â€¢ With tools:  docker compose -f docker-compose.dev.yml --profile tools up -d"
              echo ""
              echo "âœ… All services are healthy and running!"
              echo ""

    # Optional: pgAdmin for database management
    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: klask-pgadmin
        environment:
            PGADMIN_DEFAULT_EMAIL: admin@klask.dev
            PGADMIN_DEFAULT_PASSWORD: admin
            PGADMIN_CONFIG_SERVER_MODE: "False"
        ports:
            - "5050:80"
        depends_on:
            - postgres
        networks:
            - klask-network
        profiles:
            - tools
        restart: unless-stopped

    # Redis for caching (optional for future use)
    redis:
        image: redis:7-alpine
        container_name: klask-redis
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        command: redis-server --appendonly yes
        networks:
            - klask-network
        profiles:
            - tools
        restart: unless-stopped

volumes:
    postgres_data:
    redis_data:
    klask_data:
    klask_index:

networks:
    klask-network:
        driver: bridge
